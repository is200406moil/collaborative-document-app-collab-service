name: Collaborative App CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  # –û–±—â–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–º–µ–Ω–∏ Docker-–æ–±—Ä–∞–∑–∞
  IMAGE_NAME: collab-service-app

jobs:
  # ===============================================
  # JOB 1: –°–ë–û–†–ö–ê –ò –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ë–≠–ö–ï–ù–î –°–ï–†–í–ò–°–ê (CI)
  # ===============================================
  backend_build_and_push:
    runs-on: ubuntu-latest
    
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # 1. –°–±–æ—Ä–∫–∞ Java-–∫–æ–¥–∞ —Å Maven
    - name: üì¶ Maven Build (CI)
      run: |
        echo "–ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞, –≥–¥–µ –ª–µ–∂–∏—Ç pom.xml: collab-service/"
        cd collab-service 
        mvn clean install -DskipTests 
        
    # 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # 3. –í—Ö–æ–¥ –≤ Docker Hub (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã)
    - name: üîí Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }} 
        password: ${{ secrets.DOCKER_PASSWORD }} 
        
    # 4. –°–±–æ—Ä–∫–∞ –∏ –ü—É–±–ª–∏–∫–∞—Ü–∏—è Docker-–æ–±—Ä–∞–∑–∞
    - name: üèóÔ∏è Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .                                  # –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ ‚Äî –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        file: ./Dockerfile                          # Dockerfile –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ
        push: true                                  # –ü—É–±–ª–∏–∫—É–µ–º –æ–±—Ä–∞–∑ –≤ Docker Hub
        tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ===============================================
  # JOB 2: –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï (CD)
  # ===============================================
  deploy_to_render:
    runs-on: ubuntu-latest
    needs: backend_build_and_push # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4
      
    - name: üöÄ Trigger Render Deploy Hook
      if: success() # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π Job —É—Å–ø–µ—à–µ–Ω
      run: |
        echo "–¢—Ä–∏–≥–≥–µ—Ä —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ Render."
        # –ï—Å–ª–∏ Render —Å–ª–µ–¥–∏—Ç –∑–∞ Docker Hub, —ç—Ç–æ—Ç —à–∞–≥ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —è–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä:
        # curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }} 
        echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ. Render –∑–∞–±–µ—Ä–µ—Ç –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ –∏–∑ Docker Hub."
