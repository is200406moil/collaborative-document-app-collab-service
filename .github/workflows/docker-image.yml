name: Collaborative App CI/CD Pipeline (3 Stages)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  # –û–±—â–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–º–µ–Ω–∏ Docker-–æ–±—Ä–∞–∑–∞
  IMAGE_NAME: collab-service-app
  PROJECT_PATH: collab-service # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ, –≥–¥–µ –ª–µ–∂–∏—Ç pom.xml

jobs:
  # ===============================================
  # JOB 1: –í–û–†–û–¢–ê –ö–ê–ß–ï–°–¢–í–ê (Unit & Integration Tests)
  # ===============================================
  unit_tests:
    runs-on: ubuntu-latest
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Set up JDK 17 and Maven Cache
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: üß™ Run Maven Tests (Unit & Integration)
      run: |
        echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ –ø–∞–ø–∫–µ: ${{ env.PROJECT_PATH }}"
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã. –ï—Å–ª–∏ –æ–Ω–∏ –ø—Ä–æ–≤–∞–ª—è—Ç—Å—è, –≤–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.
        cd ${{ env.PROJECT_PATH }}
        mvn clean verify
  
  # ===============================================
  # JOB 2: –°–ë–û–†–ö–ê –ò –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ë–≠–ö–ï–ù–î –°–ï–†–í–ò–°–ê (CI)
  # ===============================================
  backend_build_and_push:
    runs-on: ubuntu-latest
    needs: unit_tests # <--- –ó–ê–í–ò–°–ò–ú–û–°–¢–¨: –ó–∞–ø—É—Å—Ç–∏—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
    
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Set up JDK 17 and Maven Cache
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # 1. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–±–æ—Ä–∫–∞ (—É–∂–µ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤, —Ç.–∫. –æ–Ω–∏ –ø—Ä–æ—à–ª–∏)
    - name: üì¶ Maven Package
      run: |
        cd ${{ env.PROJECT_PATH }}
        mvn package -DskipTests 
        
    # 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # 3. –í—Ö–æ–¥ –≤ Docker Hub
    - name: üîí Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }} 
        password: ${{ secrets.DOCKER_PASSWORD }} 
        
    # 4. –°–±–æ—Ä–∫–∞ –∏ –ü—É–±–ª–∏–∫–∞—Ü–∏—è Docker-–æ–±—Ä–∞–∑–∞
    - name: üèóÔ∏è Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .                                  
        file: ./Dockerfile                          
        push: true                                  
        tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ===============================================
  # JOB 3: –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï (CD)
  # ===============================================
  deploy_to_render:
    runs-on: ubuntu-latest
    needs: backend_build_and_push # <--- –ó–ê–í–ò–°–ò–ú–û–°–¢–¨: –ó–∞–ø—É—Å—Ç–∏—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±—Ä–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω
    
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4
      
    - name: üöÄ Trigger Render Deploy Hook
      if: success()
      run: |
        echo "–¢—Ä–∏–≥–≥–µ—Ä —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ Render."
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —è–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —á–µ—Ä–µ–∑ Webhook, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
        # curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }} 
        echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ. Render –∑–∞–±–µ—Ä–µ—Ç –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ –∏–∑ Docker Hub."
