name: Docker CI/CD Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # –®–ê–ì 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Java (CI)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º cd –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ (collab-service/), –≥–¥–µ –ª–µ–∂–∏—Ç pom.xml
    - name: üì¶ Maven Build and Tests (CI)
      run: |
        echo "–ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞: collab-service/"
        cd collab-service 
        # –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ Maven, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞–µ—Ç JAR-—Ñ–∞–π–ª –≤ target/
        mvn clean install -DskipTests 
        
    # --- Docker Image Build (CD) ---
    
    # –®–ê–ì 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
    - name: üè∑Ô∏è Define Docker Tag
      id: docker_tag
      run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT 

    # –®–ê–ì 3: –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∫–æ—Ä–Ω–µ –∏ Dockerfile –∏–∑ –∫–æ—Ä–Ω—è.
    # Dockerfile, –≤–µ—Ä–æ—è—Ç–Ω–æ, –∫–æ–ø–∏—Ä—É–µ—Ç JAR –∏–∑ ./collab-service/target/
    - name: üèóÔ∏è Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .                                  # –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ ‚Äî –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        file: ./Dockerfile                          # Dockerfile –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ
        push: false                                 # –ù–µ –ø—É—à–∏–º –≤ Registry, –µ—Å–ª–∏ –¥–µ–ø–ª–æ–π –Ω–∞ Render –∏–¥–µ—Ç —á–µ—Ä–µ–∑ CI/CD
        tags: collaborative-document-app:latest, collaborative-document-app:${{ steps.docker_tag.outputs.TAG }}
