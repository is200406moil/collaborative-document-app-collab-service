name: Docker CI/CD Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # –®–ê–ì 1: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–£–¢–ò
    - name: üîç List files and folders for debugging
      run: |
        echo "Current working directory:"
        pwd
        echo "Files and folders in this directory (–∏—â–µ–º pom.xml –∏–ª–∏ –ø–∞–ø–∫—É, –≥–¥–µ –æ–Ω –ª–µ–∂–∏—Ç):"
        ls -F
    
    # –®–ê–ì 2: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Java (CI)
    # –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –ï—Å–ª–∏ –≤–∞—à pom.xml –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–µ –≤ 'collab-service/',
    # –∑–∞–º–µ–Ω–∏—Ç–µ 'collab-service' –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–æ–≤ –®–ê–ì–ê 1.
    - name: üì¶ Maven Build and Tests (CI)
      run: |
        # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É, –≥–¥–µ –ª–µ–∂–∏—Ç pom.xml
        cd collab-service 
        # –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ Maven
        mvn clean install -DskipTests 
        
    # --- Docker Image Build (CD) ---
    
    # –®–ê–ì 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–≥–∞ –∏ —Å–±–æ—Ä–∫–∞ Docker
    - name: üè∑Ô∏è Define Docker Tag
      id: docker_tag
      run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT 

    - name: üèóÔ∏è Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./collab-service # –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–∞–ø–∫–æ–π, –≥–¥–µ –ª–µ–∂–∏—Ç Dockerfile
        push: false 
        tags: collaborative-document-app:latest, collaborative-document-app:${{ steps.docker_tag.outputs.TAG }}
