name: Docker CI/CD Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # Ğ¨ĞĞ“ 1: Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ ĞŸĞ£Ğ¢Ğ˜
    - name: ğŸ” List files and folders for debugging
      run: |
        echo "Current working directory:"
        pwd
        echo "Files and folders in this directory (Ğ¸Ñ‰ĞµĞ¼ pom.xml Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ğ¿ĞºÑƒ, Ğ³Ğ´Ğµ Ğ¾Ğ½ Ğ»ĞµĞ¶Ğ¸Ñ‚):"
        ls -F
    
    # Ğ¨ĞĞ“ 2: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Java (CI)
    # ĞŸĞ Ğ˜ĞœĞ•Ğ§ĞĞĞ˜Ğ•: Ğ•ÑĞ»Ğ¸ Ğ²Ğ°Ñˆ pom.xml Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ½Ğµ Ğ² 'collab-service/',
    # Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ 'collab-service' Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¨ĞĞ“Ğ 1.
    - name: ğŸ“¦ Maven Build and Tests (CI)
      run: |
        # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ, Ğ³Ğ´Ğµ Ğ»ĞµĞ¶Ğ¸Ñ‚ pom.xml
        cd collab-service 
        # Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞ±Ğ¾Ñ€ĞºĞ¸ Maven
        mvn clean install -DskipTests 
        
    # --- Docker Image Build (CD) ---
    
    # Ğ¨ĞĞ“ 3: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ³Ğ° Ğ¸ ÑĞ±Ğ¾Ñ€ĞºĞ° Docker
    - name: ğŸ·ï¸ Define Docker Tag
      id: docker_tag
      run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT 

    - name: ğŸ—ï¸ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false 
        tags: collaborative-document-app:latest, collaborative-document-app:${{ steps.docker_tag.outputs.TAG }}
